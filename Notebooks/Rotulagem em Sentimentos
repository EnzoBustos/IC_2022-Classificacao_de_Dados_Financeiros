{"nbformat":4,"nbformat_minor":0,"metadata":{"colab":{"name":"Rotulagem em Sentimentos","provenance":[],"collapsed_sections":[],"mount_file_id":"1LUMhroaAtM2WGwF6oOi0Js72GUSpYJCN","authorship_tag":"ABX9TyOR+RQPpr7om7hut14FzUN7"},"kernelspec":{"name":"python3","display_name":"Python 3"},"language_info":{"name":"python"},"accelerator":"GPU","widgets":{"application/vnd.jupyter.widget-state+json":{"8532a3510eb4413391098194b88a6d65":{"model_module":"@jupyter-widgets/controls","model_name":"HBoxModel","model_module_version":"1.5.0","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_fbb8930886f543da96da6c69e3117d8a","IPY_MODEL_3992d2a675974affb2ee11bcd89aefe6","IPY_MODEL_12cdd10006ef49c7bfe825ef69533a94"],"layout":"IPY_MODEL_2690f36ee0e746659b37d7e88f4b6686"}},"fbb8930886f543da96da6c69e3117d8a":{"model_module":"@jupyter-widgets/controls","model_name":"HTMLModel","model_module_version":"1.5.0","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"HTMLView","description":"","description_tooltip":null,"layout":"IPY_MODEL_2bb082a624af4673a46de562a1dbd083","placeholder":"​","style":"IPY_MODEL_45942afd9f8f43db91d5f1bdd493d2a9","value":"Batches: 100%"}},"3992d2a675974affb2ee11bcd89aefe6":{"model_module":"@jupyter-widgets/controls","model_name":"FloatProgressModel","model_module_version":"1.5.0","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"ProgressView","bar_style":"success","description":"","description_tooltip":null,"layout":"IPY_MODEL_531c9342e383475292e9577f3599b91d","max":9227,"min":0,"orientation":"horizontal","style":"IPY_MODEL_7e065ddde13e49dea76aaadf926d7a02","value":9227}},"12cdd10006ef49c7bfe825ef69533a94":{"model_module":"@jupyter-widgets/controls","model_name":"HTMLModel","model_module_version":"1.5.0","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"1.5.0","_view_name":"HTMLView","description":"","description_tooltip":null,"layout":"IPY_MODEL_dc72aea11b814ce68db66dec852c46dc","placeholder":"​","style":"IPY_MODEL_d1996a2a49e74a4583b7dbbe0a503abd","value":" 9227/9227 [09:25&lt;00:00, 67.74it/s]"}},"2690f36ee0e746659b37d7e88f4b6686":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"2bb082a624af4673a46de562a1dbd083":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"45942afd9f8f43db91d5f1bdd493d2a9":{"model_module":"@jupyter-widgets/controls","model_name":"DescriptionStyleModel","model_module_version":"1.5.0","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"DescriptionStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","description_width":""}},"531c9342e383475292e9577f3599b91d":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"7e065ddde13e49dea76aaadf926d7a02":{"model_module":"@jupyter-widgets/controls","model_name":"ProgressStyleModel","model_module_version":"1.5.0","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"dc72aea11b814ce68db66dec852c46dc":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","model_module_version":"1.2.0","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"1.2.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"overflow_x":null,"overflow_y":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"d1996a2a49e74a4583b7dbbe0a503abd":{"model_module":"@jupyter-widgets/controls","model_name":"DescriptionStyleModel","model_module_version":"1.5.0","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_model_name":"DescriptionStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"1.2.0","_view_name":"StyleView","description_width":""}}}},"gpuClass":"standard"},"cells":[{"cell_type":"markdown","source":["# Instalando Dependências"],"metadata":{"id":"GiWXf4bUWHUa"}},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"Z80yUXf4Ud72","executionInfo":{"status":"ok","timestamp":1655679087130,"user_tz":180,"elapsed":18711,"user":{"displayName":"Enzo Bustos da Silva","userId":"00423683093258305256"}},"outputId":"63dc62b2-882e-4b3e-940e-e75cd856a391"},"outputs":[{"output_type":"stream","name":"stdout","text":["Looking in indexes: https://pypi.org/simple, https://us-python.pkg.dev/colab-wheels/public/simple/\n","Requirement already satisfied: transformers in /usr/local/lib/python3.7/dist-packages (4.20.0)\n","Requirement already satisfied: requests in /usr/local/lib/python3.7/dist-packages (from transformers) (2.23.0)\n","Requirement already satisfied: numpy>=1.17 in /usr/local/lib/python3.7/dist-packages (from transformers) (1.21.6)\n","Requirement already satisfied: huggingface-hub<1.0,>=0.1.0 in /usr/local/lib/python3.7/dist-packages (from transformers) (0.7.0)\n","Requirement already satisfied: importlib-metadata in /usr/local/lib/python3.7/dist-packages (from transformers) (4.11.4)\n","Requirement already satisfied: tqdm>=4.27 in /usr/local/lib/python3.7/dist-packages (from transformers) (4.64.0)\n","Requirement already satisfied: tokenizers!=0.11.3,<0.13,>=0.11.1 in /usr/local/lib/python3.7/dist-packages (from transformers) (0.12.1)\n","Requirement already satisfied: pyyaml>=5.1 in /usr/local/lib/python3.7/dist-packages (from transformers) (5.4.1)\n","Requirement already satisfied: regex!=2019.12.17 in /usr/local/lib/python3.7/dist-packages (from transformers) (2022.6.2)\n","Requirement already satisfied: packaging>=20.0 in /usr/local/lib/python3.7/dist-packages (from transformers) (21.3)\n","Requirement already satisfied: filelock in /usr/local/lib/python3.7/dist-packages (from transformers) (3.7.1)\n","Requirement already satisfied: typing-extensions>=3.7.4.3 in /usr/local/lib/python3.7/dist-packages (from huggingface-hub<1.0,>=0.1.0->transformers) (4.1.1)\n","Requirement already satisfied: pyparsing!=3.0.5,>=2.0.2 in /usr/local/lib/python3.7/dist-packages (from packaging>=20.0->transformers) (3.0.9)\n","Requirement already satisfied: zipp>=0.5 in /usr/local/lib/python3.7/dist-packages (from importlib-metadata->transformers) (3.8.0)\n","Requirement already satisfied: urllib3!=1.25.0,!=1.25.1,<1.26,>=1.21.1 in /usr/local/lib/python3.7/dist-packages (from requests->transformers) (1.24.3)\n","Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.7/dist-packages (from requests->transformers) (2022.6.15)\n","Requirement already satisfied: chardet<4,>=3.0.2 in /usr/local/lib/python3.7/dist-packages (from requests->transformers) (3.0.4)\n","Requirement already satisfied: idna<3,>=2.5 in /usr/local/lib/python3.7/dist-packages (from requests->transformers) (2.10)\n","Looking in indexes: https://pypi.org/simple, https://us-python.pkg.dev/colab-wheels/public/simple/\n","Requirement already satisfied: sentencepiece in /usr/local/lib/python3.7/dist-packages (0.1.96)\n","Looking in indexes: https://pypi.org/simple, https://us-python.pkg.dev/colab-wheels/public/simple/\n","Requirement already satisfied: bertopic in /usr/local/lib/python3.7/dist-packages (0.10.0)\n","Requirement already satisfied: umap-learn>=0.5.0 in /usr/local/lib/python3.7/dist-packages (from bertopic) (0.5.3)\n","Requirement already satisfied: pandas>=1.1.5 in /usr/local/lib/python3.7/dist-packages (from bertopic) (1.3.5)\n","Requirement already satisfied: plotly>=4.7.0 in /usr/local/lib/python3.7/dist-packages (from bertopic) (5.5.0)\n","Requirement already satisfied: scikit-learn>=0.22.2.post1 in /usr/local/lib/python3.7/dist-packages (from bertopic) (1.0.2)\n","Requirement already satisfied: numpy>=1.20.0 in /usr/local/lib/python3.7/dist-packages (from bertopic) (1.21.6)\n","Requirement already satisfied: hdbscan>=0.8.28 in /usr/local/lib/python3.7/dist-packages (from bertopic) (0.8.28)\n","Requirement already satisfied: sentence-transformers>=0.4.1 in /usr/local/lib/python3.7/dist-packages (from bertopic) (2.2.0)\n","Requirement already satisfied: tqdm>=4.41.1 in /usr/local/lib/python3.7/dist-packages (from bertopic) (4.64.0)\n","Requirement already satisfied: pyyaml<6.0 in /usr/local/lib/python3.7/dist-packages (from bertopic) (5.4.1)\n","Requirement already satisfied: scipy>=1.0 in /usr/local/lib/python3.7/dist-packages (from hdbscan>=0.8.28->bertopic) (1.4.1)\n","Requirement already satisfied: joblib>=1.0 in /usr/local/lib/python3.7/dist-packages (from hdbscan>=0.8.28->bertopic) (1.1.0)\n","Requirement already satisfied: cython>=0.27 in /usr/local/lib/python3.7/dist-packages (from hdbscan>=0.8.28->bertopic) (0.29.30)\n","Requirement already satisfied: python-dateutil>=2.7.3 in /usr/local/lib/python3.7/dist-packages (from pandas>=1.1.5->bertopic) (2.8.2)\n","Requirement already satisfied: pytz>=2017.3 in /usr/local/lib/python3.7/dist-packages (from pandas>=1.1.5->bertopic) (2022.1)\n","Requirement already satisfied: six in /usr/local/lib/python3.7/dist-packages (from plotly>=4.7.0->bertopic) (1.15.0)\n","Requirement already satisfied: tenacity>=6.2.0 in /usr/local/lib/python3.7/dist-packages (from plotly>=4.7.0->bertopic) (8.0.1)\n","Requirement already satisfied: threadpoolctl>=2.0.0 in /usr/local/lib/python3.7/dist-packages (from scikit-learn>=0.22.2.post1->bertopic) (3.1.0)\n","Requirement already satisfied: torchvision in /usr/local/lib/python3.7/dist-packages (from sentence-transformers>=0.4.1->bertopic) (0.12.0+cu113)\n","Requirement already satisfied: sentencepiece in /usr/local/lib/python3.7/dist-packages (from sentence-transformers>=0.4.1->bertopic) (0.1.96)\n","Requirement already satisfied: nltk in /usr/local/lib/python3.7/dist-packages (from sentence-transformers>=0.4.1->bertopic) (3.7)\n","Requirement already satisfied: transformers<5.0.0,>=4.6.0 in /usr/local/lib/python3.7/dist-packages (from sentence-transformers>=0.4.1->bertopic) (4.20.0)\n","Requirement already satisfied: huggingface-hub in /usr/local/lib/python3.7/dist-packages (from sentence-transformers>=0.4.1->bertopic) (0.7.0)\n","Requirement already satisfied: torch>=1.6.0 in /usr/local/lib/python3.7/dist-packages (from sentence-transformers>=0.4.1->bertopic) (1.11.0+cu113)\n","Requirement already satisfied: typing-extensions in /usr/local/lib/python3.7/dist-packages (from torch>=1.6.0->sentence-transformers>=0.4.1->bertopic) (4.1.1)\n","Requirement already satisfied: requests in /usr/local/lib/python3.7/dist-packages (from transformers<5.0.0,>=4.6.0->sentence-transformers>=0.4.1->bertopic) (2.23.0)\n","Requirement already satisfied: filelock in /usr/local/lib/python3.7/dist-packages (from transformers<5.0.0,>=4.6.0->sentence-transformers>=0.4.1->bertopic) (3.7.1)\n","Requirement already satisfied: packaging>=20.0 in /usr/local/lib/python3.7/dist-packages (from transformers<5.0.0,>=4.6.0->sentence-transformers>=0.4.1->bertopic) (21.3)\n","Requirement already satisfied: importlib-metadata in /usr/local/lib/python3.7/dist-packages (from transformers<5.0.0,>=4.6.0->sentence-transformers>=0.4.1->bertopic) (4.11.4)\n","Requirement already satisfied: regex!=2019.12.17 in /usr/local/lib/python3.7/dist-packages (from transformers<5.0.0,>=4.6.0->sentence-transformers>=0.4.1->bertopic) (2022.6.2)\n","Requirement already satisfied: tokenizers!=0.11.3,<0.13,>=0.11.1 in /usr/local/lib/python3.7/dist-packages (from transformers<5.0.0,>=4.6.0->sentence-transformers>=0.4.1->bertopic) (0.12.1)\n","Requirement already satisfied: pyparsing!=3.0.5,>=2.0.2 in /usr/local/lib/python3.7/dist-packages (from packaging>=20.0->transformers<5.0.0,>=4.6.0->sentence-transformers>=0.4.1->bertopic) (3.0.9)\n","Requirement already satisfied: numba>=0.49 in /usr/local/lib/python3.7/dist-packages (from umap-learn>=0.5.0->bertopic) (0.51.2)\n","Requirement already satisfied: pynndescent>=0.5 in /usr/local/lib/python3.7/dist-packages (from umap-learn>=0.5.0->bertopic) (0.5.7)\n","Requirement already satisfied: llvmlite<0.35,>=0.34.0.dev0 in /usr/local/lib/python3.7/dist-packages (from numba>=0.49->umap-learn>=0.5.0->bertopic) (0.34.0)\n","Requirement already satisfied: setuptools in /usr/local/lib/python3.7/dist-packages (from numba>=0.49->umap-learn>=0.5.0->bertopic) (57.4.0)\n","Requirement already satisfied: zipp>=0.5 in /usr/local/lib/python3.7/dist-packages (from importlib-metadata->transformers<5.0.0,>=4.6.0->sentence-transformers>=0.4.1->bertopic) (3.8.0)\n","Requirement already satisfied: click in /usr/local/lib/python3.7/dist-packages (from nltk->sentence-transformers>=0.4.1->bertopic) (7.1.2)\n","Requirement already satisfied: chardet<4,>=3.0.2 in /usr/local/lib/python3.7/dist-packages (from requests->transformers<5.0.0,>=4.6.0->sentence-transformers>=0.4.1->bertopic) (3.0.4)\n","Requirement already satisfied: urllib3!=1.25.0,!=1.25.1,<1.26,>=1.21.1 in /usr/local/lib/python3.7/dist-packages (from requests->transformers<5.0.0,>=4.6.0->sentence-transformers>=0.4.1->bertopic) (1.24.3)\n","Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.7/dist-packages (from requests->transformers<5.0.0,>=4.6.0->sentence-transformers>=0.4.1->bertopic) (2022.6.15)\n","Requirement already satisfied: idna<3,>=2.5 in /usr/local/lib/python3.7/dist-packages (from requests->transformers<5.0.0,>=4.6.0->sentence-transformers>=0.4.1->bertopic) (2.10)\n","Requirement already satisfied: pillow!=8.3.*,>=5.3.0 in /usr/local/lib/python3.7/dist-packages (from torchvision->sentence-transformers>=0.4.1->bertopic) (7.1.2)\n"]}],"source":["!pip install transformers\n","!pip install sentencepiece\n","!pip install bertopic"]},{"cell_type":"markdown","source":["# Carregando dados"],"metadata":{"id":"jkpDjZ1eWK6H"}},{"cell_type":"code","source":["import pandas as pd\n","from tqdm.notebook import tqdm\n","import numpy as np\n","tqdm.pandas()\n","\n","np.random.seed(42)\n","\n","df = pd.read_excel(\"/content/drive/MyDrive/Iniciação Científica/IC 2022/Data/just_brute_financial_texts.xlsx\")\n","df = df.loc[~pd.isnull(df[\"theme_brute\"])]\n","df.drop(\"Unnamed: 0\", axis=1, inplace=True)\n","df.head()"],"metadata":{"id":"RQ-Ku4XCWKbT","executionInfo":{"status":"ok","timestamp":1655679148281,"user_tz":180,"elapsed":61159,"user":{"displayName":"Enzo Bustos da Silva","userId":"00423683093258305256"}},"colab":{"base_uri":"https://localhost:8080/","height":206},"outputId":"aee544bf-092d-4a43-ba56-2a4169a934e1"},"execution_count":null,"outputs":[{"output_type":"execute_result","data":{"text/plain":["                        date  \\\n","0  2011-12-06 00:47:32+00:00   \n","1  2012-03-06 16:07:43+00:00   \n","2  2018-01-03 17:00:00+00:00   \n","3  2012-09-25 03:00:08+00:00   \n","4  2011-08-23 05:32:42+00:00   \n","\n","                                                 url  \\\n","0  https://valor.globo.com/noticia/2011/12/06/rai...   \n","1  https://valor.globo.com/noticia/2012/03/06/rio...   \n","2  https://exame.com/negocios/6-empresas-de-fast-...   \n","3  https://valor.globo.com/empresas/noticia/2012/...   \n","4  https://valor.globo.com/noticia/2011/08/23/imp...   \n","\n","                                               texts  is_title  \\\n","0  Raia Drogasil substitui conselho fiscal por co...      True   \n","1  NAIRÓBI - A Rio+20, a conferência das Nações U...     False   \n","2  O foco da holding Infinity Services, dona da H...     False   \n","3  Em 1982, o Brasil enfrentava uma das crises fi...     False   \n","4  Com um aumento de 39% nas compras feitas no ex...     False   \n","\n","        theme_brute  old_index  \n","0             Saúde          0  \n","1        Financeiro          9  \n","2        Financeiro         11  \n","3        Financeiro         12  \n","4  Bens Industriais         13  "],"text/html":["\n","  <div id=\"df-bfcca8f9-8589-46ff-9e26-59465009a5e5\">\n","    <div class=\"colab-df-container\">\n","      <div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>date</th>\n","      <th>url</th>\n","      <th>texts</th>\n","      <th>is_title</th>\n","      <th>theme_brute</th>\n","      <th>old_index</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>0</th>\n","      <td>2011-12-06 00:47:32+00:00</td>\n","      <td>https://valor.globo.com/noticia/2011/12/06/rai...</td>\n","      <td>Raia Drogasil substitui conselho fiscal por co...</td>\n","      <td>True</td>\n","      <td>Saúde</td>\n","      <td>0</td>\n","    </tr>\n","    <tr>\n","      <th>1</th>\n","      <td>2012-03-06 16:07:43+00:00</td>\n","      <td>https://valor.globo.com/noticia/2012/03/06/rio...</td>\n","      <td>NAIRÓBI - A Rio+20, a conferência das Nações U...</td>\n","      <td>False</td>\n","      <td>Financeiro</td>\n","      <td>9</td>\n","    </tr>\n","    <tr>\n","      <th>2</th>\n","      <td>2018-01-03 17:00:00+00:00</td>\n","      <td>https://exame.com/negocios/6-empresas-de-fast-...</td>\n","      <td>O foco da holding Infinity Services, dona da H...</td>\n","      <td>False</td>\n","      <td>Financeiro</td>\n","      <td>11</td>\n","    </tr>\n","    <tr>\n","      <th>3</th>\n","      <td>2012-09-25 03:00:08+00:00</td>\n","      <td>https://valor.globo.com/empresas/noticia/2012/...</td>\n","      <td>Em 1982, o Brasil enfrentava uma das crises fi...</td>\n","      <td>False</td>\n","      <td>Financeiro</td>\n","      <td>12</td>\n","    </tr>\n","    <tr>\n","      <th>4</th>\n","      <td>2011-08-23 05:32:42+00:00</td>\n","      <td>https://valor.globo.com/noticia/2011/08/23/imp...</td>\n","      <td>Com um aumento de 39% nas compras feitas no ex...</td>\n","      <td>False</td>\n","      <td>Bens Industriais</td>\n","      <td>13</td>\n","    </tr>\n","  </tbody>\n","</table>\n","</div>\n","      <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-bfcca8f9-8589-46ff-9e26-59465009a5e5')\"\n","              title=\"Convert this dataframe to an interactive table.\"\n","              style=\"display:none;\">\n","        \n","  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n","       width=\"24px\">\n","    <path d=\"M0 0h24v24H0V0z\" fill=\"none\"/>\n","    <path d=\"M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z\"/><path d=\"M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z\"/>\n","  </svg>\n","      </button>\n","      \n","  <style>\n","    .colab-df-container {\n","      display:flex;\n","      flex-wrap:wrap;\n","      gap: 12px;\n","    }\n","\n","    .colab-df-convert {\n","      background-color: #E8F0FE;\n","      border: none;\n","      border-radius: 50%;\n","      cursor: pointer;\n","      display: none;\n","      fill: #1967D2;\n","      height: 32px;\n","      padding: 0 0 0 0;\n","      width: 32px;\n","    }\n","\n","    .colab-df-convert:hover {\n","      background-color: #E2EBFA;\n","      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n","      fill: #174EA6;\n","    }\n","\n","    [theme=dark] .colab-df-convert {\n","      background-color: #3B4455;\n","      fill: #D2E3FC;\n","    }\n","\n","    [theme=dark] .colab-df-convert:hover {\n","      background-color: #434B5C;\n","      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n","      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n","      fill: #FFFFFF;\n","    }\n","  </style>\n","\n","      <script>\n","        const buttonEl =\n","          document.querySelector('#df-bfcca8f9-8589-46ff-9e26-59465009a5e5 button.colab-df-convert');\n","        buttonEl.style.display =\n","          google.colab.kernel.accessAllowed ? 'block' : 'none';\n","\n","        async function convertToInteractive(key) {\n","          const element = document.querySelector('#df-bfcca8f9-8589-46ff-9e26-59465009a5e5');\n","          const dataTable =\n","            await google.colab.kernel.invokeFunction('convertToInteractive',\n","                                                     [key], {});\n","          if (!dataTable) return;\n","\n","          const docLinkHtml = 'Like what you see? Visit the ' +\n","            '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n","            + ' to learn more about interactive tables.';\n","          element.innerHTML = '';\n","          dataTable['output_type'] = 'display_data';\n","          await google.colab.output.renderOutput(dataTable, element);\n","          const docLink = document.createElement('div');\n","          docLink.innerHTML = docLinkHtml;\n","          element.appendChild(docLink);\n","        }\n","      </script>\n","    </div>\n","  </div>\n","  "]},"metadata":{},"execution_count":2}]},{"cell_type":"markdown","source":["# BERTopic"],"metadata":{"id":"_PFDdVq9nnT_"}},{"cell_type":"code","source":["from bertopic import BERTopic\n","from sklearn.feature_extraction.text import CountVectorizer\n","\n","vectorizer_model = CountVectorizer(stop_words=\"portuguese\", min_df=10)\n","topic_model = BERTopic(language=\"portuguese\", nr_topics=72, n_gram_range=(1, 3),\n","                       calculate_probabilities=True, verbose=True,\n","                       min_topic_size=20, top_n_words=10, low_memory=True,\n","                       vectorizer_model=vectorizer_model)"],"metadata":{"id":"hdDn0bCmVMwC"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["def topic_probs_to_df(model,probabilities):\n","  number_of_topics = pd.DataFrame(model.get_topic_info().Topic[1:])\n","  return pd.DataFrame(probabilities,columns=number_of_topics[\"Topic\"])\n","\n","def get_all_topic_words(model, nth_topic):\n","  a = model.get_topic(nth_topic) #list\n","  return \", \".join([i[0] for i in a])   #turns list to text concatenated, with commas in between\n","\n","def fit_docs_to_model(model, docs):\n","  topics, probabilities = model.fit_transform(docs)\n","  return topic_probs_to_df(model, probabilities)\n","\n","def topic_info_to_df(model):\n","  topic_words_list = []\n","  df_topics = model.get_topic_info()[1:]\n","  for number in range(len(df_topics)):\n","    topic_words_list.append(get_all_topic_words(model, number))\n","  df_topics[\"words\"] = topic_words_list\n","  return df_topics"],"metadata":{"id":"4UajSiT8lx7u"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["documents = df[\"texts\"].tolist()"],"metadata":{"id":"-N75sv5EKRym"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["result_df = fit_docs_to_model(topic_model, documents)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/","height":138,"referenced_widgets":["8532a3510eb4413391098194b88a6d65","fbb8930886f543da96da6c69e3117d8a","3992d2a675974affb2ee11bcd89aefe6","12cdd10006ef49c7bfe825ef69533a94","2690f36ee0e746659b37d7e88f4b6686","2bb082a624af4673a46de562a1dbd083","45942afd9f8f43db91d5f1bdd493d2a9","531c9342e383475292e9577f3599b91d","7e065ddde13e49dea76aaadf926d7a02","dc72aea11b814ce68db66dec852c46dc","d1996a2a49e74a4583b7dbbe0a503abd"]},"id":"l-Yc7SAGKSfE","outputId":"71f700b6-6ace-465c-9f36-4fd0dc763072"},"execution_count":null,"outputs":[{"output_type":"display_data","data":{"text/plain":["Batches:   0%|          | 0/9227 [00:00<?, ?it/s]"],"application/vnd.jupyter.widget-view+json":{"version_major":2,"version_minor":0,"model_id":"8532a3510eb4413391098194b88a6d65"}},"metadata":{}},{"output_type":"stream","name":"stderr","text":["2022-06-19 23:21:10,820 - BERTopic - Transformed documents to Embeddings\n","/usr/local/lib/python3.7/dist-packages/numba/np/ufunc/parallel.py:363: NumbaWarning: The TBB threading layer requires TBB version 2019.5 or later i.e., TBB_INTERFACE_VERSION >= 11005. Found TBB_INTERFACE_VERSION = 9107. The TBB threading layer is disabled.\n","  warnings.warn(problem)\n","2022-06-19 23:36:25,060 - BERTopic - Reduced dimensionality\n"]}]},{"cell_type":"code","source":["topic_info_df = topic_info_to_df(topic_model)"],"metadata":{"id":"-j81QokhKVYk"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["normalized_results = result_df.div(result_df.sum(axis=1), axis=0)"],"metadata":{"id":"hxCm9SVoKVa2"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["reindexed_bert_results = normalized_results.rename(columns={-1: 0})"],"metadata":{"id":"RwtOLJYT-Ws0"},"execution_count":null,"outputs":[]},{"cell_type":"markdown","source":["# Zero-Shot"],"metadata":{"id":"EKr8F2n-nph4"}},{"cell_type":"code","source":["labels = [\n","          [\"Positivo\", \"Indiferente\", \"Negativo\"],\n","          [\"Positivo\", \"Indiferente\", \"Pessimista\"],\n","          [\"Positivo\", \"Indiferente\", \"Ruim\"],\n","          [\"Otimista\", \"Indiferente\", \"Negativo\"],\n","          [\"Otimista\", \"Indiferente\", \"Pessimista\"],\n","          [\"Otimista\", \"Indiferente\", \"Ruim\"],\n","          [\"Ótimo\"   , \"Indiferente\", \"Negativo\"],\n","          [\"Ótimo\"   , \"Indiferente\", \"Pessimista\"],\n","          [\"Ótimo\"   , \"Indiferente\", \"Ruim\"],\n","          [\"Positivo\", \"Neutro\",      \"Negativo\"],\n","          [\"Positivo\", \"Neutro\",      \"Pessimista\"],\n","          [\"Positivo\", \"Neutro\",      \"Ruim\"],\n","          [\"Otimista\", \"Neutro\",      \"Negativo\"],\n","          [\"Otimista\", \"Neutro\",      \"Pessimista\"],\n","          [\"Otimista\", \"Neutro\",      \"Ruim\"],\n","          [\"Ótimo\"   , \"Neutro\",      \"Negativo\"],\n","          [\"Ótimo\"   , \"Neutro\",      \"Pessimista\"],\n","          [\"Ótimo\"   , \"Neutro\",      \"Ruim\"],\n","         ]\n","\n","template = \"O sentimento desse conjunto de palavras é {}.\""],"metadata":{"id":"w95FD6YqcwHu"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["from transformers import pipeline\n","\n","classifier = pipeline(\"zero-shot-classification\",\n","                      model=\"joeddav/xlm-roberta-large-xnli\")"],"metadata":{"id":"MH8MLf3boYjX"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["def zero_shot_classify(classifier, topics, labels, template):\n","    return topics.progress_apply(lambda word_sequence: classifier(word_sequence,\n","                                                                  candidate_labels=labels,\n","                                                                  hypothesis_template=template,\n","                                                                  multi_label=False))\n","\n","zeroshot_results = []\n","for label in labels:\n","    zeroshot_results.append(zero_shot_classify(classifier, topic_info_df[\"words\"], label, template))"],"metadata":{"id":"L1-9XK66oaPL"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["def mapper(item_tuple):\n","  index, item = item_tuple\n","  return dict(zip(item[\"labels\"], item[\"scores\"]))\n","\n","topic_to_label_df = []\n","results_df = []\n","speech2theme_df = []\n","\n","for i in tqdm(range(len(labels))):\n","    topic_to_label_df.append(pd.DataFrame(list(map(mapper, enumerate(zeroshot_results[i])))))\n","    speech2theme_df.append(reindexed_bert_results @ topic_to_label_df[i])\n","    results_df.append(pd.DataFrame(speech2theme_df[i].apply(lambda row : row.idxmax(),axis=1)))\n","    df[\"sentiment_{}\".format(str(i))] = results_df[i][0]"],"metadata":{"id":"FSJIn--PrrDm"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["from collections import Counter\n","\n","def most_frequent(List):\n","    occurence_count = Counter(List)\n","    return occurence_count.most_common(1)[0][0]\n","\n","for i in tqdm(range(len(labels))):\n","    df['sentiment_{}'.format(str(i))] = df['sentiment_{}'.format(str(i))].replace([\"Ótimo\", \"Otimista\"], \"Positivo\")\n","    df['sentiment_{}'.format(str(i))] = df['sentiment_{}'.format(str(i))].replace([\"Ruim\", \"Pessimista\"], \"Negativo\")\n","    df['sentiment_{}'.format(str(i))] = df['sentiment_{}'.format(str(i))].replace(\"Indiferente\", \"Neutro\")\n","\n","true_sentiment = []\n","\n","for i in tqdm(range(len(df))):\n","    sentiments = [\n","                  df[\"sentiment_0\"][i],\n","                  df[\"sentiment_1\"][i],\n","                  df[\"sentiment_2\"][i],\n","                  df[\"sentiment_3\"][i],\n","                  df[\"sentiment_4\"][i],\n","                  df[\"sentiment_5\"][i],\n","                  df[\"sentiment_6\"][i],\n","                  df[\"sentiment_7\"][i],\n","                  df[\"sentiment_8\"][i],\n","                  df[\"sentiment_9\"][i],\n","                  df[\"sentiment_10\"][i],\n","                  df[\"sentiment_11\"][i],\n","                  df[\"sentiment_12\"][i],\n","                  df[\"sentiment_13\"][i],\n","                  df[\"sentiment_14\"][i],\n","                  df[\"sentiment_15\"][i],\n","                  df[\"sentiment_16\"][i],\n","                  df[\"sentiment_17\"][i],\n","    ]\n","    true_sentiment.append(most_frequent(sentiments))\n","\n","df[\"true_sentiment\"] = true_sentiment\n","\n","df.to_excel(\"/content/with_sentiments_financial_texts.xlsx\", index=False)"],"metadata":{"id":"zSn8Amsqy5Cn"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["df[\"true_sentiment\"].value_counts()"],"metadata":{"id":"jEw_1h0kAgYO"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["import seaborn as sns\n","sns.set(rc={'figure.figsize':(16, 10)})\n","sns.countplot(df[\"true_sentiment\"])"],"metadata":{"id":"6e4pGGT-AkEQ"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":[""],"metadata":{"id":"BimsFH6zh8iv"},"execution_count":null,"outputs":[]}]}